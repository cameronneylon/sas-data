<html>
  <head>
    <style type="text/css">
      .hll { background-color: #ffffcc }
      .c { color: #888888 } /* Comment */
      .err { color: #a61717; background-color: #e3d2d2 } /* Error */
      .k { color: #008800; font-weight: bold } /* Keyword */
      .cm { color: #888888 } /* Comment.Multiline */
      .cp { color: #cc0000; font-weight: bold } /* Comment.Preproc */
      .c1 { color: #888888 } /* Comment.Single */
      .cs { color: #cc0000; font-weight: bold; background-color: #fff0f0 } /* Comment.Special */
      .gd { color: #000000; background-color: #ffdddd } /* Generic.Deleted */
      .ge { font-style: italic } /* Generic.Emph */
      .gr { color: #aa0000 } /* Generic.Error */
      .gh { color: #303030 } /* Generic.Heading */
      .gi { color: #000000; background-color: #ddffdd } /* Generic.Inserted */
      .go { color: #888888 } /* Generic.Output */
      .gp { color: #555555 } /* Generic.Prompt */
      .gs { font-weight: bold } /* Generic.Strong */
      .gu { color: #606060 } /* Generic.Subheading */
      .gt { color: #aa0000 } /* Generic.Traceback */
      .kc { color: #008800; font-weight: bold } /* Keyword.Constant */
      .kd { color: #008800; font-weight: bold } /* Keyword.Declaration */
      .kn { color: #008800; font-weight: bold } /* Keyword.Namespace */
      .kp { color: #008800 } /* Keyword.Pseudo */
      .kr { color: #008800; font-weight: bold } /* Keyword.Reserved */
      .kt { color: #888888; font-weight: bold } /* Keyword.Type */
      .m { color: #0000DD; font-weight: bold } /* Literal.Number */
      .s { color: #dd2200; background-color: #fff0f0 } /* Literal.String */
      .na { color: #336699 } /* Name.Attribute */
      .nb { color: #003388 } /* Name.Builtin */
      .nc { color: #bb0066; font-weight: bold } /* Name.Class */
      .no { color: #003366; font-weight: bold } /* Name.Constant */
      .nd { color: #555555 } /* Name.Decorator */
      .ne { color: #bb0066; font-weight: bold } /* Name.Exception */
      .nf { color: #0066bb; font-weight: bold } /* Name.Function */
      .nl { color: #336699; font-style: italic } /* Name.Label */
      .nn { color: #bb0066; font-weight: bold } /* Name.Namespace */
      .py { color: #336699; font-weight: bold } /* Name.Property */
      .nt { color: #bb0066; font-weight: bold } /* Name.Tag */
      .nv { color: #336699 } /* Name.Variable */
      .ow { color: #008800 } /* Operator.Word */
      .w { color: #bbbbbb } /* Text.Whitespace */
      .mf { color: #0000DD; font-weight: bold } /* Literal.Number.Float */
      .mh { color: #0000DD; font-weight: bold } /* Literal.Number.Hex */
      .mi { color: #0000DD; font-weight: bold } /* Literal.Number.Integer */
      .mo { color: #0000DD; font-weight: bold } /* Literal.Number.Oct */
      .sb { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Backtick */
      .sc { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Char */
      .sd { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Doc */
      .s2 { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Double */
      .se { color: #0044dd; background-color: #fff0f0 } /* Literal.String.Escape */
      .sh { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Heredoc */
      .si { color: #3333bb; background-color: #fff0f0 } /* Literal.String.Interpol */
      .sx { color: #22bb22; background-color: #f0fff0 } /* Literal.String.Other */
      .sr { color: #008800; background-color: #fff0ff } /* Literal.String.Regex */
      .s1 { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Single */
      .ss { color: #aa6600; background-color: #fff0f0 } /* Literal.String.Symbol */
      .bp { color: #003388 } /* Name.Builtin.Pseudo */
      .vc { color: #336699 } /* Name.Variable.Class */
      .vg { color: #dd7700 } /* Name.Variable.Global */
      .vi { color: #3333bb } /* Name.Variable.Instance */
      .il { color: #0000DD; font-weight: bold } /* Literal.Number.Integer.Long */
    </style>
  </head>
  <body>

<h1>Utility methods for retrieving Data from SAS experiments from the LaBLog</h1>
<h1>Outline</h1>
<p>Utility methods for collecting SAS data data from the blog </p>
<h1>Getting the data post URLs</h1>
<p>I'm re-using some of the code that I used to generate the structured data from tables. The method grabs a list of posts that match a key value pair. The method takes a main blog URL, the key and the value desired.</p>
<div class="highlight"><pre><a name="l-1"></a><span class="k">def</span> <span class="nf">getposts</span><span class="p">(</span><span class="n">blogurl</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">from_date</span><span class="p">,</span> <span class="n">to_date</span><span class="p">):</span>
<a name="l-2"></a>    <span class="sd">&quot;&quot;&quot;Obtain list of posts matching key=key and value=value&quot;&quot;&quot;</span>
</pre></div>

<p>A request URL is then constructed and called.</p>
<div class="highlight"><pre><a name="l-1"></a>    <span class="n">requesturl</span> <span class="o">=</span> <span class="n">blogurl</span> <span class="o">+</span> <span class="s">&#39;/meta/&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">&#39;/value/&#39;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s">&#39;/index.xml&#39;</span>
<a name="l-2"></a>
<a name="l-3"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">requesturl</span><span class="p">)</span>
</pre></div>

<p>The returned page of XML is then parsed using ElementTree (inside a try clause) and a list of posts is generated and returned checking against the dates that were set.</p>
<div class="highlight"><pre><a name="l-1"></a>    <span class="k">try</span><span class="p">:</span>
<a name="l-2"></a>        <span class="n">parsedresponse</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<a name="l-3"></a>    <span class="k">except</span> <span class="n">URLError</span><span class="p">:</span>
<a name="l-4"></a>        <span class="k">return</span> <span class="p">[]</span>
<a name="l-5"></a>
<a name="l-6"></a>    <span class="n">postlist</span> <span class="o">=</span> <span class="p">[]</span>
<a name="l-7"></a>    <span class="n">posts</span> <span class="o">=</span> <span class="n">parsedresponse</span><span class="o">.</span><span class="n">getiterator</span><span class="p">(</span><span class="s">&#39;post&#39;</span><span class="p">)</span>
<a name="l-8"></a>    <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">posts</span><span class="p">:</span>
<a name="l-9"></a>        <span class="n">post_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
<a name="l-10"></a>                <span class="n">post</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;datestamp&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">],</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">)</span>
<a name="l-11"></a>        
<a name="l-12"></a>        <span class="k">if</span> <span class="n">post_date</span> <span class="o">&gt;</span> <span class="n">from_date</span> <span class="ow">and</span> <span class="n">post_date</span> <span class="o">&lt;</span> <span class="n">to_date</span><span class="p">:</span>
<a name="l-13"></a>            <span class="n">postlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;formats&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&#39;format&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<a name="l-14"></a>
<a name="l-15"></a>    <span class="k">return</span> <span class="n">postlist</span>
</pre></div>

<h1>Getting the data from the data posts</h1>
<p>We still now need to go through to the data posts and then get the actual data file as a stream. The method to do this takes a URL for ad at a post, opens up the post XML and parses the response.</p>
<div class="highlight"><pre><a name="l-1"></a><span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">posturl</span><span class="p">):</span>
<a name="l-2"></a>    <span class="sd">&quot;&quot;&quot;Recovers .DAT or CanSAS XML files given a blog data post URL&quot;&quot;&quot;</span>
<a name="l-3"></a>
<a name="l-4"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">posturl</span><span class="p">)</span>
<a name="l-5"></a>    <span class="n">parsedresponse</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</pre></div>

<p>We then need to find the link to the actual data object container. There can be multiple data containers in each post. For the current set of I22 data there is only one to worry about.</p>
<div class="highlight"><pre><a name="l-1"></a>    <span class="n">dataurllist</span> <span class="o">=</span> <span class="n">parsedresponse</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;post&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
<a name="l-2"></a>        <span class="s">&#39;attached_data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getiterator</span><span class="p">(</span><span class="s">&#39;data&#39;</span><span class="p">)</span>
</pre></div>

<p>The data container then has to be read to find the actual download link</p>
<div class="highlight"><pre><a name="l-1"></a>    <span class="k">for</span> <span class="n">dataurl</span> <span class="ow">in</span> <span class="n">dataurllist</span><span class="p">:</span>
<a name="l-2"></a>        <span class="n">filepost</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">dataurl</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<a name="l-3"></a>        <span class="n">parsedfilepost</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">filepost</span><span class="p">)</span>
<a name="l-4"></a>        <span class="n">fileurl</span> <span class="o">=</span> <span class="n">parsedfilepost</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;dataitems&#39;</span>
<a name="l-5"></a>                                      <span class="p">)</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&#39;dataitem&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
</pre></div>

<p>With the fileurl in hand we can finally obtain the data and create a SASData object.</p>
  </body>
</html>

